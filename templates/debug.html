<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP Management Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-panel { background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 10px 0; }
        .data-display { background: white; padding: 15px; border: 1px solid #ddd; border-radius: 4px; margin: 10px 0; }
        .error { background: #ffebee; border-color: #f44336; color: #d32f2f; }
        .success { background: #e8f5e8; border-color: #4caf50; color: #2e7d32; }
        button { padding: 10px 20px; margin: 5px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #1976d2; }
        pre { background: #f5f5f5; padding: 10px; overflow: auto; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>üîç IP Management Debug Tool</h1>
    
    <div class="debug-panel">
        <h3>API Tests</h3>
        <button onclick="testAPI('/api/ipam/port-ips')">Test Port IPs API</button>
        <button onclick="testAPI('/api/ipam/stats')">Test Stats API</button>
        <button onclick="testAPI('/api/ipam/ip-conflicts')">Test Conflicts API</button>
        <button onclick="testAllAPIs()">Test All APIs</button>
    </div>

    <div id="results"></div>

    <script>
        async function testAPI(endpoint) {
            const resultsDiv = document.getElementById('results');
            const startTime = Date.now();
            
            try {
                console.log(`üîÑ Testing ${endpoint}...`);
                const response = await fetch(endpoint);
                const endTime = Date.now();
                const data = await response.json();
                
                const resultHTML = `
                    <div class="data-display ${response.ok ? 'success' : 'error'}">
                        <h4>‚úÖ ${endpoint}</h4>
                        <p><strong>Status:</strong> ${response.status} ${response.statusText}</p>
                        <p><strong>Response Time:</strong> ${endTime - startTime}ms</p>
                        <p><strong>Data Type:</strong> ${typeof data}</p>
                        ${typeof data === 'object' ? `<p><strong>Keys:</strong> ${Object.keys(data).length}</p>` : ''}
                        <details>
                            <summary>View Raw Data</summary>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </details>
                    </div>
                `;
                
                resultsDiv.innerHTML = resultHTML + resultsDiv.innerHTML;
                
                // Test the actual data processing
                if (endpoint === '/api/ipam/port-ips') {
                    testDataProcessing(data);
                }
                
            } catch (error) {
                const resultHTML = `
                    <div class="data-display error">
                        <h4>‚ùå ${endpoint}</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <pre>${error.stack}</pre>
                    </div>
                `;
                resultsDiv.innerHTML = resultHTML + resultsDiv.innerHTML;
            }
        }

        function testDataProcessing(portData) {
            console.log('üß™ Testing data processing...');
            
            if (!portData || typeof portData !== 'object') {
                console.error('‚ùå Invalid port data type:', typeof portData);
                return;
            }
            
            const keys = Object.keys(portData);
            console.log('üìä Port data keys:', keys.length);
            
            if (keys.length > 0) {
                const firstKey = keys[0];
                const firstData = portData[firstKey];
                console.log('üìã First subnet:', firstKey, firstData);
                
                // Test the HTML generation
                const testHTML = Object.entries(portData)
                    .slice(0, 3)
                    .map(([subnet, data]) => {
                        return `
                            <div style="border: 1px solid #ddd; padding: 10px; margin: 5px;">
                                <strong>${subnet}</strong><br>
                                IPs: ${data.total_ips || 0}<br>
                                Devices: ${data.total_devices || 0}
                            </div>
                        `;
                    }).join('');
                
                document.getElementById('results').innerHTML = `
                    <div class="data-display success">
                        <h4>üéØ Processed HTML Preview</h4>
                        ${testHTML}
                    </div>
                ` + document.getElementById('results').innerHTML;
            }
        }

        async function testAllAPIs() {
            await testAPI('/api/ipam/stats');
            await testAPI('/api/ipam/port-ips');
            await testAPI('/api/ipam/ip-conflicts');
        }

        // Auto-run tests on page load
        window.onload = function() {
            console.log('üöÄ Debug page loaded, running initial tests...');
            testAllAPIs();
        };
    </script>
</body>
</html>

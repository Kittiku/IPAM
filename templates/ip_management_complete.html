<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPAM - IP Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .tab-button {
            padding: 0.75rem 1.5rem;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .tab-button.active {
            border-bottom-color: #8b5cf6;
            color: #8b5cf6;
            background-color: #f3f4f6;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .conflict-badge {
            animation: pulse 2s infinite;
        }
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <i class="fas fa-network-wired text-2xl text-white mr-3"></i>
                    <div>
                        <h1 class="text-2xl font-bold text-white">IP Management System</h1>
                        <p class="text-purple-100">Advanced network analysis and conflict detection</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <div id="connection-status" class="bg-green-500 text-white px-3 py-1 rounded-full text-sm">
                        <i class="fas fa-check-circle mr-1"></i>Connected
                    </div>
                    <a href="/" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-home mr-2"></i>Dashboard
                    </a>
                    <button onclick="loadAllData()" 
                            class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Quick Stats Cards -->
        <div id="quick-stats" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow-md p-4 card-hover">
                <div class="flex items-center">
                    <div class="bg-purple-100 rounded-lg p-3 mr-3">
                        <i class="fas fa-network-wired text-purple-600"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Total Subnets</p>
                        <p id="total-subnets" class="text-xl font-bold text-gray-800">Loading...</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-4 card-hover">
                <div class="flex items-center">
                    <div class="bg-blue-100 rounded-lg p-3 mr-3">
                        <i class="fas fa-server text-blue-600"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Port Interfaces</p>
                        <p id="total-interfaces" class="text-xl font-bold text-gray-800">Loading...</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-4 card-hover">
                <div class="flex items-center">
                    <div class="bg-red-100 rounded-lg p-3 mr-3">
                        <i class="fas fa-exclamation-triangle text-red-600"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">IP Conflicts</p>
                        <p id="total-conflicts" class="text-xl font-bold text-red-600">Loading...</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-4 card-hover">
                <div class="flex items-center">
                    <div class="bg-green-100 rounded-lg p-3 mr-3">
                        <i class="fas fa-check-circle text-green-600"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Unique IPs</p>
                        <p id="unique-ips" class="text-xl font-bold text-green-600">Loading...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="bg-white rounded-lg shadow-md mb-6">
            <div class="border-b border-gray-200">
                <div class="flex overflow-x-auto">
                    <button class="tab-button active" onclick="showTab('overview-tab', this)">
                        <i class="fas fa-chart-bar mr-2"></i>Overview
                    </button>
                    <button class="tab-button" onclick="showTab('conflicts-tab', this)">
                        <i class="fas fa-exclamation-triangle mr-2"></i>IP Conflicts
                    </button>
                    <button class="tab-button" onclick="showTab('subnets-tab', this)">
                        <i class="fas fa-network-wired mr-2"></i>Subnet Analysis
                    </button>
                    <button class="tab-button" onclick="showTab('tools-tab', this)">
                        <i class="fas fa-tools mr-2"></i>IP Tools
                    </button>
                </div>
            </div>

            <!-- Overview Tab -->
            <div id="overview-tab" class="tab-content active p-6">
                <h2 class="text-xl font-semibold mb-6">Network Overview</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- IP Distribution Chart -->
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-medium mb-4">IP Distribution by Subnet</h3>
                        <div id="ip-distribution" class="space-y-3">
                            <!-- Data will be loaded here -->
                        </div>
                    </div>

                    <!-- Conflict Summary -->
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-medium mb-4">Conflict Summary</h3>
                        <div id="conflict-summary">
                            <div class="text-center py-8">
                                <i class="fas fa-spinner loading-spinner text-2xl text-gray-400"></i>
                                <p class="text-gray-500 mt-2">Analyzing conflicts...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="bg-gray-50 rounded-lg p-6">
                    <h3 class="text-lg font-medium mb-4">System Status</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600" id="health-score">98%</div>
                            <div class="text-sm text-gray-600">Network Health</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600" id="utilization-rate">-</div>
                            <div class="text-sm text-gray-600">IP Utilization</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-purple-600" id="last-scan">Just now</div>
                            <div class="text-sm text-gray-600">Last Scan</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- IP Conflicts Tab -->
            <div id="conflicts-tab" class="tab-content p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold">IP Address Conflicts</h2>
                    <button onclick="refreshConflicts()" 
                            class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-exclamation-triangle mr-2"></i>Scan for Conflicts
                    </button>
                </div>

                <!-- Conflicts Filter -->
                <div class="mb-6">
                    <div class="flex flex-wrap gap-4">
                        <input type="text" id="conflict-filter" placeholder="Filter by IP address..." 
                               class="flex-1 min-w-64 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <select id="severity-filter" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="">All Severities</option>
                            <option value="high">High (5+ conflicts)</option>
                            <option value="medium">Medium (3-4 conflicts)</option>
                            <option value="low">Low (2 conflicts)</option>
                        </select>
                        <button onclick="applyConflictFilters()" 
                                class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg transition-colors">
                            <i class="fas fa-filter mr-2"></i>Filter
                        </button>
                    </div>
                </div>

                <!-- Conflicts List -->
                <div id="conflicts-list">
                    <div class="text-center py-8">
                        <i class="fas fa-spinner loading-spinner text-2xl text-gray-400"></i>
                        <p class="text-gray-500 mt-2">Loading IP conflicts...</p>
                    </div>
                </div>
            </div>

            <!-- Subnet Analysis Tab -->
            <div id="subnets-tab" class="tab-content p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold">Subnet Analysis</h2>
                    <button onclick="refreshSubnets()" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-network-wired mr-2"></i>Refresh Analysis
                    </button>
                </div>

                <!-- Subnet Filter -->
                <div class="mb-6">
                    <input type="text" id="subnet-filter" placeholder="Filter subnets (e.g., 192.168.1.0/24)..." 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                           onkeyup="filterSubnets()">
                </div>

                <!-- Subnets Grid -->
                <div id="subnets-grid">
                    <div class="text-center py-8">
                        <i class="fas fa-spinner loading-spinner text-2xl text-gray-400"></i>
                        <p class="text-gray-500 mt-2">Loading subnet data...</p>
                    </div>
                </div>
            </div>

            <!-- IP Tools Tab -->
            <div id="tools-tab" class="tab-content p-6">
                <h2 class="text-xl font-semibold mb-6">IP Management Tools</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Subnet Calculator -->
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-medium mb-4">
                            <i class="fas fa-calculator mr-2 text-blue-600"></i>Subnet Calculator
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Network Address</label>
                                <input type="text" id="calc-network" placeholder="e.g., 192.168.1.0/24" 
                                       class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <button onclick="calculateSubnet()" 
                                    class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg transition-colors">
                                <i class="fas fa-calculator mr-2"></i>Calculate
                            </button>
                            <div id="calc-result" class="mt-4"></div>
                        </div>
                    </div>

                    <!-- IP Availability Checker -->
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-medium mb-4">
                            <i class="fas fa-search mr-2 text-green-600"></i>IP Availability Checker
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Subnet to Check</label>
                                <input type="text" id="check-subnet" placeholder="e.g., 192.168.1.0/24" 
                                       class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Number of IPs Needed</label>
                                <input type="number" id="check-count" value="10" min="1" max="254"
                                       class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <button onclick="checkAvailability()" 
                                    class="w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg transition-colors">
                                <i class="fas fa-search mr-2"></i>Check Availability
                            </button>
                            <div id="check-result" class="mt-4"></div>
                        </div>
                    </div>
                </div>

                <!-- Bulk Operations -->
                <div class="mt-6 bg-gray-50 rounded-lg p-6">
                    <h3 class="text-lg font-medium mb-4">
                        <i class="fas fa-tasks mr-2 text-purple-600"></i>Bulk Operations
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <button onclick="exportConflicts()" 
                                class="bg-purple-600 hover:bg-purple-700 text-white py-3 px-4 rounded-lg transition-colors">
                            <i class="fas fa-download mr-2"></i>Export Conflicts
                        </button>
                        <button onclick="exportSubnets()" 
                                class="bg-purple-600 hover:bg-purple-700 text-white py-3 px-4 rounded-lg transition-colors">
                            <i class="fas fa-download mr-2"></i>Export Subnets
                        </button>
                        <button onclick="generateReport()" 
                                class="bg-purple-600 hover:bg-purple-700 text-white py-3 px-4 rounded-lg transition-colors">
                            <i class="fas fa-file-pdf mr-2"></i>Generate Report
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let systemData = {
            portIPs: {},
            conflicts: [],
            stats: {}
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DOM loaded, initializing...');
            
            // Show loading state
            document.getElementById('ip-distribution').innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-spinner loading-spinner text-2xl text-gray-400"></i>
                    <p class="text-gray-500 mt-2">Loading distribution data...</p>
                </div>
            `;
            
            // Load data
            loadAllData();
        });

        async function loadAllData() {
            try {
                console.log('🔄 Starting to load data...');
                
                const [portResponse, conflictsResponse, statsResponse] = await Promise.all([
                    fetch('/api/ipam/port-ips'),
                    fetch('/api/ipam/ip-conflicts'),
                    fetch('/api/ipam/stats')
                ]);

                console.log('📊 API responses received:', {
                    portStatus: portResponse.status,
                    conflictsStatus: conflictsResponse.status,
                    statsStatus: statsResponse.status
                });

                systemData.portIPs = await portResponse.json();
                systemData.conflicts = await conflictsResponse.json();
                systemData.stats = await statsResponse.json();

                console.log('✅ Data loaded:', {
                    portIPs: Object.keys(systemData.portIPs).length,
                    conflicts: systemData.conflicts.total_conflicts,
                    stats: systemData.stats.total_devices
                });

                updateQuickStats();
                updateOverviewTab();
                updateConflictsTab();
                updateSubnetsTab();
                updateConnectionStatus(true);

            } catch (error) {
                console.error('❌ Error loading data:', error);
                updateConnectionStatus(false);
                
                // Show error message in UI
                document.getElementById('ip-distribution').innerHTML = `
                    <div class="text-center text-red-500 py-8">
                        <i class="fas fa-exclamation-triangle text-3xl mb-3"></i>
                        <div>Error loading data</div>
                        <div class="text-sm">${error.message}</div>
                    </div>
                `;
            }
        }

        function updateQuickStats() {
            console.log('🔄 Updating quick stats...');
            const portData = systemData.portIPs || {};
            const conflicts = systemData.conflicts || { total_conflicts: 0 };
            
            console.log('📊 Quick stats data:', {
                portDataKeys: Object.keys(portData).length,
                conflicts: conflicts.total_conflicts
            });
            
            const totalSubnets = Object.keys(portData).length;
            const totalInterfaces = Object.values(portData).reduce((sum, subnet) => sum + (subnet.total_ips || 0), 0);
            const totalConflicts = conflicts.total_conflicts || 0;
            const uniqueIPs = Object.values(portData).reduce((sum, subnet) => sum + (subnet.total_devices || 0), 0);

            console.log('📊 Calculated stats:', {
                totalSubnets, totalInterfaces, totalConflicts, uniqueIPs
            });

            document.getElementById('total-subnets').textContent = totalSubnets.toLocaleString();
            document.getElementById('total-interfaces').textContent = totalInterfaces.toLocaleString();
            document.getElementById('total-conflicts').textContent = totalConflicts.toLocaleString();
            document.getElementById('unique-ips').textContent = uniqueIPs.toLocaleString();

            // Update utilization rate
            const utilizationRate = totalInterfaces > 0 ? Math.round((uniqueIPs / totalInterfaces) * 100) : 0;
            document.getElementById('utilization-rate').textContent = utilizationRate + '%';
            
            console.log('✅ Quick stats updated successfully');
        }

        function updateOverviewTab() {
            console.log('🔄 Updating overview tab...');
            const portData = systemData.portIPs || {};
            const conflicts = systemData.conflicts || { total_conflicts: 0, conflicts: [] };

            console.log('📊 Port data:', {
                type: typeof portData,
                keys: Object.keys(portData),
                length: Object.keys(portData).length
            });

            // Check if we have data
            if (Object.keys(portData).length === 0) {
                console.log('⚠️ No port data available');
                document.getElementById('ip-distribution').innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-info-circle text-3xl mb-3"></i>
                        <div>No subnet data available</div>
                        <div class="text-sm">Click refresh to load data</div>
                        <button onclick="loadAllData()" class="mt-3 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                            <i class="fas fa-sync-alt mr-2"></i>Reload Data
                        </button>
                    </div>
                `;
                return;
            }

            console.log('✅ Generating distribution HTML...');
            // Update IP distribution - แสดงผลเหมือนหน้าทดสอบ
            const distributionHtml = Object.entries(portData)
                .slice(0, 10)
                .map(([subnet, data]) => {
                    const hasConflicts = Object.keys(data.duplicate_ips || {}).length > 0;
                    return `
                        <div class="flex justify-between items-center p-3 bg-white rounded border ${hasConflicts ? 'border-red-200' : 'border-gray-200'} hover:shadow-sm transition-shadow">
                            <div class="flex items-center">
                                <span class="font-mono text-sm">${subnet}</span>
                                ${hasConflicts ? '<i class="fas fa-exclamation-triangle text-red-500 ml-2"></i>' : ''}
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-medium text-blue-600">${(data.total_ips || 0).toLocaleString()} IPs</div>
                                <div class="text-xs text-gray-500">${(data.total_devices || 0).toLocaleString()} devices</div>
                            </div>
                        </div>
                    `;
                }).join('');

            document.getElementById('ip-distribution').innerHTML = distributionHtml;
            console.log('✅ Overview tab updated successfully');

            // Update conflict summary
            const conflictSummaryHtml = conflicts.total_conflicts > 0 ? `
                <div class="space-y-3">
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex items-center">
                            <i class="fas fa-exclamation-triangle text-red-500 mr-3"></i>
                            <div>
                                <div class="font-medium text-red-800">${conflicts.total_conflicts} IP conflicts detected</div>
                                <div class="text-sm text-red-600">Immediate attention required</div>
                            </div>
                        </div>
                    </div>
                    ${conflicts.conflicts.slice(0, 3).map(conflict => `
                        <div class="flex justify-between items-center p-3 bg-white rounded border border-red-200">
                            <span class="font-mono text-sm text-red-600">${conflict.ip}</span>
                            <span class="text-sm text-red-600">${conflict.conflict_count} conflicts</span>
                        </div>
                    `).join('')}
                </div>
            ` : `
                <div class="text-center py-8">
                    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-check text-2xl text-green-600"></i>
                    </div>
                    <div class="text-lg font-medium text-green-800 mb-2">No IP conflicts detected</div>
                    <div class="text-sm text-green-600">All IP addresses are properly assigned</div>
                </div>
            `;

            document.getElementById('conflict-summary').innerHTML = conflictSummaryHtml;
        }

            // Update conflict summary
            const conflictSummaryHtml = conflicts.total_conflicts > 0 ? `
                <div class="space-y-3">
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex items-center">
                            <i class="fas fa-exclamation-triangle text-red-500 mr-3"></i>
                            <div>
                                <div class="font-medium text-red-800">${conflicts.total_conflicts} IP conflicts detected</div>
                                <div class="text-sm text-red-600">Immediate attention required</div>
                            </div>
                        </div>
                    </div>
                    ${conflicts.conflicts.slice(0, 3).map(conflict => `
                        <div class="flex justify-between items-center p-3 bg-white rounded border border-red-200">
                            <span class="font-mono text-sm text-red-600">${conflict.ip}</span>
                            <span class="text-sm text-red-600">${conflict.conflict_count} conflicts</span>
                        </div>
                    `).join('')}
                </div>
            ` : `
                <div class="text-center py-8">
                    <i class="fas fa-check-circle text-green-500 text-3xl mb-3"></i>
                    <div class="text-green-600 font-medium">No IP conflicts detected</div>
                    <div class="text-gray-600 text-sm">All IP addresses are properly assigned</div>
                </div>
            `;

            document.getElementById('conflict-summary').innerHTML = conflictSummaryHtml;
        }

        function updateConflictsTab() {
            const conflicts = systemData.conflicts.conflicts || [];
            
            if (conflicts.length === 0) {
                document.getElementById('conflicts-list').innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-check-circle text-green-500 text-4xl mb-4"></i>
                        <h3 class="text-lg font-medium text-green-600 mb-2">No IP conflicts detected!</h3>
                        <p class="text-gray-600">All IP addresses are uniquely assigned across the network.</p>
                    </div>
                `;
                return;
            }

            const conflictsHtml = conflicts.map(conflict => {
                const severity = conflict.conflict_count >= 5 ? 'high' : 
                               conflict.conflict_count >= 3 ? 'medium' : 'low';
                const severityClass = severity === 'high' ? 'border-red-500 bg-red-50' :
                                    severity === 'medium' ? 'border-orange-500 bg-orange-50' :
                                    'border-yellow-500 bg-yellow-50';
                const severityText = severity === 'high' ? 'High Priority' :
                                   severity === 'medium' ? 'Medium Priority' : 'Low Priority';

                return `
                    <div class="border-l-4 ${severityClass} rounded-lg p-6 mb-4 card-hover">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-lg font-medium text-gray-900">
                                    <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
                                    ${conflict.ip}
                                </h3>
                                <div class="flex items-center mt-1">
                                    <span class="text-sm text-gray-600 mr-4">${conflict.conflict_count} conflicts</span>
                                    <span class="px-2 py-1 text-xs rounded-full ${
                                        severity === 'high' ? 'bg-red-100 text-red-800' :
                                        severity === 'medium' ? 'bg-orange-100 text-orange-800' :
                                        'bg-yellow-100 text-yellow-800'
                                    }">${severityText}</span>
                                </div>
                            </div>
                            <button onclick="resolveConflict('${conflict.ip}')" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition-colors">
                                <i class="fas fa-tools mr-1"></i>Resolve
                            </button>
                        </div>
                        <div class="space-y-2">
                            ${conflict.usage.map(usage => `
                                <div class="bg-white rounded border p-3">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <div class="font-medium text-gray-900">${usage.host_name}</div>
                                            <div class="text-sm text-gray-600">Interface: ${usage.interface}</div>
                                            <div class="text-sm text-gray-600">Domain: ${usage.domain || 'N/A'}</div>
                                        </div>
                                        <div class="text-right text-sm">
                                            <div class="text-gray-600">Status: ${usage.status}</div>
                                            <div class="text-gray-600">${usage.vendor || 'Unknown vendor'}</div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('conflicts-list').innerHTML = conflictsHtml;
        }

        function updateSubnetsTab() {
            const portData = systemData.portIPs;
            const subnets = Object.entries(portData).sort((a, b) => a[0].localeCompare(b[0]));

            if (subnets.length === 0) {
                document.getElementById('subnets-grid').innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-network-wired text-gray-400 text-4xl mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-600 mb-2">No subnet data available</h3>
                        <p class="text-gray-500">Port data is required for subnet analysis.</p>
                    </div>
                `;
                return;
            }

            const subnetsHtml = subnets.map(([subnet, data]) => {
                const hasConflicts = Object.keys(data.duplicate_ips || {}).length > 0;
                const conflictCount = Object.keys(data.duplicate_ips || {}).length;
                
                return `
                    <div class="bg-white rounded-lg shadow-md border ${hasConflicts ? 'border-red-200' : 'border-gray-200'} p-6 card-hover subnet-card" data-subnet="${subnet}">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-lg font-medium text-gray-900">${subnet}</h3>
                                <div class="flex items-center mt-1">
                                    <span class="text-sm text-gray-600 mr-4">${data.total_ips || 0} IPs</span>
                                    <span class="text-sm text-gray-600 mr-4">${data.total_devices || 0} devices</span>
                                    ${hasConflicts ? `<span class="px-2 py-1 text-xs bg-red-100 text-red-800 rounded-full">${conflictCount} conflicts</span>` : ''}
                                </div>
                            </div>
                            <button onclick="analyzeSubnet('${subnet}')" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition-colors">
                                <i class="fas fa-search mr-1"></i>Analyze
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-center p-3 bg-blue-50 rounded">
                                <div class="text-xl font-bold text-blue-600">${data.unique_ips ? data.unique_ips.length : 0}</div>
                                <div class="text-xs text-blue-600">Unique IPs</div>
                            </div>
                            <div class="text-center p-3 ${hasConflicts ? 'bg-red-50' : 'bg-green-50'} rounded">
                                <div class="text-xl font-bold ${hasConflicts ? 'text-red-600' : 'text-green-600'}">${conflictCount}</div>
                                <div class="text-xs ${hasConflicts ? 'text-red-600' : 'text-green-600'}">Conflicts</div>
                            </div>
                        </div>
                        
                        ${hasConflicts ? `
                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <h4 class="text-sm font-medium text-red-600 mb-2">Conflicted IPs:</h4>
                                <div class="flex flex-wrap gap-2">
                                    ${Object.keys(data.duplicate_ips).slice(0, 5).map(ip => `
                                        <span class="px-2 py-1 text-xs bg-red-100 text-red-800 rounded font-mono">${ip}</span>
                                    `).join('')}
                                    ${Object.keys(data.duplicate_ips).length > 5 ? `<span class="px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded">+${Object.keys(data.duplicate_ips).length - 5} more</span>` : ''}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            document.getElementById('subnets-grid').innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${subnetsHtml}
                </div>
            `;
        }

        // Tab Management
        function showTab(tabId, button) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab and mark button as active
            document.getElementById(tabId).classList.add('active');
            button.classList.add('active');
        }

        // Utility Functions
        function refreshConflicts() {
            loadAllData();
        }

        function refreshSubnets() {
            loadAllData();
        }

        function filterSubnets() {
            const filter = document.getElementById('subnet-filter').value.toLowerCase();
            const cards = document.querySelectorAll('.subnet-card');
            
            cards.forEach(card => {
                const subnet = card.dataset.subnet.toLowerCase();
                card.style.display = subnet.includes(filter) ? 'block' : 'none';
            });
        }

        function applyConflictFilters() {
            // Implement conflict filtering logic
            alert('Filtering conflicts...');
        }

        function calculateSubnet() {
            const network = document.getElementById('calc-network').value;
            // Implement subnet calculation
            document.getElementById('calc-result').innerHTML = `
                <div class="bg-blue-50 border border-blue-200 rounded p-3">
                    <p class="text-blue-800 text-sm">Calculation for: ${network}</p>
                    <p class="text-blue-600 text-xs mt-1">Feature coming soon!</p>
                </div>
            `;
        }

        function checkAvailability() {
            const subnet = document.getElementById('check-subnet').value;
            const count = document.getElementById('check-count').value;
            
            document.getElementById('check-result').innerHTML = `
                <div class="bg-green-50 border border-green-200 rounded p-3">
                    <p class="text-green-800 text-sm">Checking ${count} IPs in ${subnet}</p>
                    <p class="text-green-600 text-xs mt-1">Feature coming soon!</p>
                </div>
            `;
        }

        function analyzeSubnet(subnet) {
            alert(`Analyzing subnet: ${subnet}`);
        }

        function resolveConflict(ip) {
            alert(`Resolving conflicts for IP: ${ip}`);
        }

        function exportConflicts() {
            alert('Exporting conflicts data...');
        }

        function exportSubnets() {
            alert('Exporting subnets data...');
        }

        function generateReport() {
            alert('Generating comprehensive report...');
        }

        function updateConnectionStatus(connected = true) {
            const statusEl = document.getElementById('connection-status');
            if (connected) {
                statusEl.innerHTML = '<i class="fas fa-check-circle mr-1"></i>Connected';
                statusEl.className = 'bg-green-500 text-white px-3 py-1 rounded-full text-sm';
            } else {
                statusEl.innerHTML = '<i class="fas fa-exclamation-triangle mr-1"></i>Error';
                statusEl.className = 'bg-red-500 text-white px-3 py-1 rounded-full text-sm';
            }
        }

        // Auto-refresh every 2 minutes
        setInterval(loadAllData, 2 * 60 * 1000);
    </script>
</body>
</html>
